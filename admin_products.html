<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>HAKTAN - Ürün Yönetimi</title>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <style>
        body {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-display min-h-screen flex lg:h-screen lg:overflow-hidden">

    <!-- Sidebar injected via JS -->

    <main class="flex-1 flex flex-col w-full min-h-screen lg:h-screen lg:overflow-hidden">
        <!-- Mobile Header -->
        <header
            class="lg:hidden bg-white border-b border-gray-100 p-4 flex items-center justify-between sticky top-0 z-30 shrink-0">
            <h1 class="text-xl font-black text-gray-900">HAKTAN Admin</h1>
            <button onclick="window.toggleAdminSidebar()" class="text-gray-500 hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-2xl">menu</span>
            </button>
        </header>

        <header
            class="bg-white border-b border-gray-200 px-4 lg:px-8 py-5 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shrink-0">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Ürün Yönetimi</h2>
                <p class="text-gray-500 text-sm">Katalogdaki ürünleri ekleyin, düzenleyin veya silin.</p>
            </div>
            <button id="addProductBtn"
                class="w-full md:w-auto bg-primary hover:bg-[#d68311] text-white px-5 py-3 rounded-xl font-bold shadow-lg shadow-primary/20 flex items-center justify-center gap-2 transition-all active:scale-95">
                <span class="material-symbols-outlined">add</span> Yeni Ürün Ekle
            </button>
        </header>

        <div class="p-8 overflow-y-auto flex-1">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row gap-4">
                    <div class="relative flex-1">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        <input type="text" id="productSearch" placeholder="Ürün ara..."
                            class="w-full pl-10 pr-4 py-2.5 rounded-xl border-gray-200 bg-gray-50 focus:border-primary focus:ring-primary text-sm">
                    </div>
                    <select id="categoryFilter"
                        class="rounded-xl border-gray-200 bg-gray-50 focus:border-primary focus:ring-primary text-sm font-bold pr-8 py-2.5">
                        <option value="">Tüm Kategoriler</option>
                    </select>
                </div>
                <div id="productsContainer">
                    <div class="hidden lg:block overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs font-semibold">
                                <tr>
                                    <th class="px-6 py-4">ID</th>
                                    <th class="px-6 py-4">Görsel</th>
                                    <th class="px-6 py-4">Ürün Adı</th>
                                    <th class="px-6 py-4">Kategori</th>
                                    <th class="px-6 py-4">Fiyat</th>
                                    <th class="px-6 py-4">Stok</th>
                                    <th class="px-6 py-4 text-right">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <div id="productsListMobile" class="lg:hidden divide-y divide-gray-100">
                        <!-- Mobile cards injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="productModal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl scale-0 transition-transform duration-300"
            id="modalContent">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold" id="modalTitle">Yeni Ürün Ekle</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="productForm" class="p-6 space-y-6">
                <input type="hidden" name="id">
                <div class="grid grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ürün Adı</label>
                        <input type="text" name="name" required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                        <select name="category" id="modalCatSelect" required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ağırlık / Birim</label>
                        <input type="text" name="weight" placeholder="500g, 1kg vs." required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fiyat (₺)</label>
                        <input type="number" name="price" step="0.01" required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Eski Fiyat (Opsiyonel)</label>
                        <input type="number" name="oldPrice" step="0.01"
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Görsel URL</label>
                        <input type="url" name="image" required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                        <textarea name="description" rows="3" required
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary"></textarea>
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancelModalBtn"
                        class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors">İptal</button>
                    <button type="submit"
                        class="bg-primary hover:bg-[#d68311] text-white px-5 py-2.5 rounded-lg font-bold shadow-lg shadow-primary/20 transition-all active:scale-95">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="/src/admin-main.js"></script>
    <script type="module">
        import { getProducts, addProduct, updateProduct, deleteProduct, getProduct, seedProducts } from './src/modules/products.js';
        import { isAdminLoggedIn } from './src/modules/admin.js';
        import { formatPrice, CATEGORY_NAMES } from './src/modules/utils.js';

        if (!isAdminLoggedIn()) window.location.href = 'admin.html';

        window.renderAdminSidebar('products');

        let products = [];

        async function refreshData() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 font-medium text-gray-400 italic">Yükleniyor...</td></tr>';

            try {
                await seedProducts();
                products = await getProducts();
                renderTable();
            } catch (e) {
                console.error("Data load error:", e);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-red-500 italic">Hata oluştu.</td></tr>';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('productsTable');
            const filter = document.getElementById('productSearch').value.toLowerCase();
            const cat = document.getElementById('categoryFilter').value;

            const filtered = products.filter(p => {
                const matchName = p.name.toLowerCase().includes(filter);
                const matchCat = cat ? p.category === cat : true;
                return matchName && matchCat;
            });

            if (filtered.length === 0) {
                const emptyHTML = '<div class="text-center py-10 font-medium text-gray-400 italic">Ürün bulunamadı.</div>';
                tbody.innerHTML = `<tr><td colspan="7">${emptyHTML}</td></tr>`;
                document.getElementById('productsListMobile').innerHTML = emptyHTML;
                return;
            }

            // Desktop Table
            tbody.innerHTML = filtered.map(p => `
                <tr class="hover:bg-gray-50 transition-colors group">
                    <td class="px-6 py-4 font-mono text-[10px] text-gray-400 truncate max-w-[80px]" title="${p.id}">#${String(p.id).substring(0, 8)}...</td>
                    <td class="px-6 py-4"><img src="${p.image}" class="w-10 h-10 rounded object-cover border border-gray-200"></td>
                    <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-600 font-bold">${CATEGORY_NAMES[p.category] || p.category}</span></td>
                    <td class="px-6 py-4 font-bold text-gray-900">${formatPrice(p.price)}</td>
                    <td class="px-6 py-4 text-green-600 font-medium text-xs">Stokta</td>
                    <td class="px-6 py-4 text-right space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editProduct('${p.id}')" class="text-blue-500 hover:text-blue-700 p-1 rounded hover:bg-blue-50"><span class="material-symbols-outlined text-lg">edit</span></button>
                        <button onclick="window.delProduct('${p.id}')" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50"><span class="material-symbols-outlined text-lg">delete</span></button>
                    </td>
                </tr>
            `).join('');

            // Mobile List
            document.getElementById('productsListMobile').innerHTML = filtered.map(p => `
                <div class="p-4 flex items-center gap-4 hover:bg-gray-50 transition-colors group relative">
                    <div class="w-16 h-16 rounded-xl overflow-hidden border border-gray-100 shrink-0">
                        <img src="${p.image}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">#${String(p.id).substring(0, 8)}</span>
                            <span class="px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 text-[10px] font-bold">${CATEGORY_NAMES[p.category] || p.category}</span>
                        </div>
                        <h4 class="font-black text-gray-900 text-sm truncate pr-16">${p.name}</h4>
                        <div class="flex items-center justify-between mt-2">
                            <div class="font-black text-primary">${formatPrice(p.price)}</div>
                            <div class="text-green-600 font-bold text-[10px]">Stokta</div>
                        </div>
                    </div>
                    
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col gap-2">
                         <button onclick="window.editProduct('${p.id}')" 
                            class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm active:scale-90 transition-all">
                            <span class="material-symbols-outlined text-xl">edit</span>
                        </button>
                        <button onclick="window.delProduct('${p.id}')" 
                            class="w-10 h-10 rounded-xl bg-red-50 text-red-600 flex items-center justify-center shadow-sm active:scale-90 transition-all">
                            <span class="material-symbols-outlined text-xl">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal Logic
        const modal = document.getElementById('productModal');
        const modalContent = document.getElementById('modalContent');
        const form = document.getElementById('productForm');

        window.openModal = async function (id) {
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-0'), 10);

            form.reset();
            const title = document.getElementById('modalTitle');
            if (id) {
                title.textContent = 'Ürün Düzenle';
                const p = await getProduct(id);
                if (p) {
                    form.id.value = p.id;
                    form.name.value = p.name;
                    form.category.value = p.category;
                    form.price.value = p.price;
                    form.oldPrice.value = p.oldPrice || '';
                    form.weight.value = p.weight;
                    form.image.value = p.image;
                    form.description.value = p.description;
                }
            } else {
                title.textContent = 'Yeni Ürün Ekle';
                form.id.value = '';
            }
        };

        function closeModal() {
            modalContent.classList.add('scale-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Populate Categories
        const catSelect = document.getElementById('categoryFilter');
        const modalCatSelect = document.getElementById('modalCatSelect');
        Object.keys(CATEGORY_NAMES).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k;
            opt.textContent = CATEGORY_NAMES[k];
            catSelect.appendChild(opt.cloneNode(true));
            modalCatSelect.appendChild(opt);
        });

        refreshData();

        document.getElementById('productSearch').addEventListener('keyup', renderTable);
        document.getElementById('categoryFilter').addEventListener('change', renderTable);
        document.getElementById('addProductBtn').addEventListener('click', () => window.openModal());
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('cancelModalBtn').addEventListener('click', closeModal);


        // Expose helpers
        window.editProduct = window.openModal;
        window.delProduct = async function (id) {
            if (confirm('Bu ürünü silmek istediğinize emin misiniz?')) {
                await deleteProduct(id);
                await refreshData();
            }
        };

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {};
            formData.forEach((v, k) => data[k] = v);

            data.price = parseFloat(data.price);
            if (data.oldPrice) data.oldPrice = parseFloat(data.oldPrice);
            else data.oldPrice = null;

            if (data.id) {
                const id = data.id;
                delete data.id;
                await updateProduct(id, data);
            } else {
                delete data.id;
                await addProduct(data);
            }

            await refreshData();
            closeModal();
        });
    </script>
</body>

</html>